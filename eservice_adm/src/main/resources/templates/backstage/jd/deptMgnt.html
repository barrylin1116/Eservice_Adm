<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
	<head>
		<th:block th:replace="fragments/head"/>
		<style type="text/css">
			.tree-container-min{
				background-color:#FFF;
				border:0px solid#DDD;
				border-left-color:#67B2DD;
				display:block;
				padding:0;
				max-width:600px;
				max-height:500px;
			}
			.bootstrap-tagsinput input {
				border: none!important;
				width:400px;
			}
		</style>
	</head>
	<body class="no-skin">
		<th:block th:replace="fragments/navbar"/>
		<div class="main-container my-save-state" id="main-container">
			<script type="text/javascript">
				try{my.settings.loadState('main-container')}catch(e){}
			</script>
			<div th:replace="fragments/sidebar :: sidebar (funId='jdDeptMgnt')"></div>
			<div class="main-content">
				<div class="main-content-inner">
					<div class="breadcrumbs my-save-state" id="breadcrumbs">
						<ul class="breadcrumb">
							<li>
								<i class="fa fa-user" aria-hidden="true"></i>
								權限管理
								<i class="my-icon fa fa-angle-double-right"></i>
								經代專區
								<i class="my-icon fa fa-angle-double-right"></i>
								部門管理
							</li>
						</ul>
					</div>
					<div class="page-content">
						<div class="row">
							<div>
								<div class="col-xs-10 col-sm-5">
									<div class="widget-box">
										<div class="widget-header">
											<h4 class="widget-title">部門樹</h4>
										</div>
										<div class="widget-body">
											<div id="aceTreeDiv" class="widget-main no-padding">
												<div class="tree-container-min">
													<ul id="aceTree"></ul>
												</div>
												<div class="space-4"></div>
											</div>
										</div>
									</div>
								</div>
								<div class="col-xs-12 col-sm-5" id="nodeDiv" hidden="true">
									<div class="widget-box">
										<div class="widget-header">
											<h4 class="widget-title">項目屬性設定</h4>
										</div>
										<div class="widget-body">
											<div class="widget-main no-padding">
												<form id="nodeForm">
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right">上層部門：</label>
														<div class="col-sm-8" id="parentDepDiv"></div>
														<input type="hidden" id="parentDepName"/>
														<input type="hidden" id="parentDep"/>
<!-- 														<input type="hidden" id="depId"/> -->
														<input type="hidden" id="notify"/>
													</fieldset>
<!--													<fieldset>-->
<!--														<label class="col-sm-4 control-label no-padding-right">通路代碼：</label>-->
<!--														<div class="col-sm-8">-->
<!--															<input type="text" id="parentDep" class="form-control" readonly="readonly"/>-->
<!--														</div>-->
<!--													</fieldset>-->
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right">部門代碼：</label>
														<div class="col-sm-8">
															<input type="text" id="depId" class="form-control" readonly="readonly"/>
														</div>
													</fieldset>
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right"><label class="red">*</label>部門名稱：</label>
														<div class="col-sm-8">
															<input type="text" id="depName" class="form-control" />
														</div>
													</fieldset>
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right"><label class="red">*</label>原機構代碼：</label>
														<div class="col-sm-8">
															<input type="text" id="branchId" class="form-control" />
														</div>
													</fieldset>
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right">附註說明：</label>
														<div class="col-sm-8">
															<input type="text" id="description" class="form-control" />
														</div>
													</fieldset>
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right"><label class="red">*</label>通路印章圖：</label>
														<div class="col-sm-8">
															<input type="file" id="sealImage" class="form-control" name="sealImage" accept=".png, .jpg, .jpeg" />
															<!-- 顯示圖片的區塊 -->
															<img id="sealImagePreview" style="max-width: 100%; display: none;" />
															<!-- 隱藏欄位：存儲Base64的圖片碼 -->
															<input type="hidden" id="stampFileBase64" name="STAMP_FILE_BASE64"/>
															<!-- 新增刪除圖片的按鈕 -->
															<button type="button" id="removeImageBtn" class="btn btn-danger" style="display: none;">刪除圖片</button>
														</div>
													</fieldset>
													<div class="form-actions center">
														<button type="button" id="addNodeBtn" class="btn btn-primary">
															<i class="ace-icon glyphicon glyphicon-plus" aria-hidden="true"></i>
															新增部門 
														</button>
														<button type="button" id="delNodeBtn" class="btn">
															<i class="ace-icon fa fa-trash-o bigger-120" aria-hidden="true"></i>
															刪除部門
														</button>
														<button type="button" id="updNodeBtn" class="btn btn-success">
															<i class="ace-icon fa fa-check" aria-hidden="true"></i>
															更新部門
														</button>
													</div>
												</form>
											</div>
										</div>
									</div>
								</div>
								<div class="col-xs-12 col-sm-5" id="rootDiv" style="display: none">
									<div class="widget-box">
										<div class="widget-header">
											<h4 class="widget-title">部門管理</h4>
										</div>
										<div class="widget-body">
											<div class="widget-main no-padding">
												<form>
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right">上層部門：</label>
														<div class="col-sm-8"></div>
													</fieldset>
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right"><label class="red">*</label>部門名稱：</label>
														<div class="col-sm-8">
															<input type="text" id="depName" class="form-control" />
														</div>
													</fieldset>
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right">附註說明：</label>
														<div class="col-sm-8">
															<input type="text" id="description" class="form-control" />
														</div>
													</fieldset>
													<fieldset>
														<label class="col-sm-4 control-label no-padding-right"><label class="red">*</label>通路印章圖：</label>
														<div class="col-sm-8">
															<input type="file" id="sealImage" class="form-control" name="sealImage" accept=".png, .jpg, .jpeg" />
															<!-- 顯示圖片的區塊 -->
															<img id="sealImagePreview" style="max-width: 100%; display: none;" />
															<!-- 隱藏欄位：存儲Base64的圖片碼 -->
															<input type="hidden" id="stampFileBase64" name="STAMP_FILE_BASE64"/>
															<!-- 新增刪除圖片的按鈕 -->
															<button type="button" id="removeImageBtn" class="btn btn-danger" style="display: none;">刪除圖片</button>
														</div>
													</fieldset>
													<div class="form-actions center">
														<button id="addRootBtn" type="button" class="btn btn-primary">
															<i class="ace-icon glyphicon glyphicon-plus" aria-hidden="true"></i>
															新增部門
														</button>
													</div>
												</form>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div id="dialog-message" class="hide">
								<div class="widget-main no-padding">
									<form id="addForm">
										<fieldset>
											<label class="col-sm-4 control-label no-padding-right">上層部門：</label>
											<div class="col-sm-8" id="parentDepDiv"></div>
										</fieldset>
										<fieldset>
											<label class="col-sm-4 control-label no-padding-right"><label class="red">*</label>部門代碼：</label>
											<div class="col-sm-8">
												<input type="text" id="depId" class="form-control" />
											</div>
										</fieldset>
										<fieldset>
											<label class="col-sm-4 control-label no-padding-right"><label class="red">*</label>部門名稱：</label>
											<div class="col-sm-8">
												<input type="text" id="depName" class="form-control" />
											</div>
										</fieldset>
										<fieldset>
											<label class="col-sm-4 control-label no-padding-right"><label class="red">*</label>原機構代碼：</label>
											<div class="col-sm-8">
												<input type="text" id="branchId" class="form-control" />
											</div>
										</fieldset>
										<fieldset>
											<label class="col-sm-4 control-label no-padding-right">附註說明：</label>
											<div class="col-sm-8">
												<input type="text" id="description" class="form-control" />
											</div>
										</fieldset>
										<fieldset>
											<label class="col-sm-4 control-label no-padding-right"><label class="red">*</label>通路印章圖：</label>
											<div class="col-sm-8">
												<input type="file" id="sealImage" class="form-control" name="sealImage" accept=".png, .jpg, .jpeg" />
												<!-- 顯示圖片的區塊 -->
												<img id="sealImagePreview" style="max-width: 100%; display: none;" />
												<!-- 隱藏欄位：存儲Base64的圖片碼 -->
												<input type="hidden" id="stampFileBase64" name="STAMP_FILE_BASE64"/>
												<!-- 新增刪除圖片的按鈕 -->
												<button type="button" id="removeImageBtn" class="btn btn-danger" style="display: none;">刪除圖片</button>
											</div>
										</fieldset>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div th:replace="fragments/footer"></div>
			<a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
				<i class="my-icon fa fa-angle-double-up icon-only bigger-110"></i>
			</a>
		</div>
	</body>
	<th:block th:replace="fragments/script"/>
	<script>
		document.addEventListener("DOMContentLoaded", () => {
			// 取得所有的檔案輸入欄位
			const fileInputs = document.querySelectorAll("#sealImage");
			// 為每個檔案輸入欄位綁定事件
			fileInputs.forEach((fileInput) => {
				const errorMsg = fileInput.parentNode.querySelector("#errorMsg"); // 確保錯誤訊息與對應
				const previewImg = fileInput.parentNode.querySelector("#sealImagePreview"); // 圖片預覽
				const base64Input = fileInput.parentNode.querySelector("#stampFileBase64"); // Base64 隱藏欄位
				const removeBtn = fileInput.parentNode.querySelector("#removeImageBtn"); // 刪除按鈕
				// 綁定檔案改變事件
				fileInput.addEventListener("change", function () {
					if (this.files.length === 0) return; // 如果未選擇檔案，直接返回

					const file = this.files[0];
					const maxSize = 2 * 1024 * 1024; // 2MB in bytes

					// 檢查檔案大小
					if (file.size > maxSize) {
						errorMsg.style.display = "block"; // 顯示錯誤訊息
						this.value = ""; // 清空檔案輸入
						previewImg.style.display = "none"; // 隱藏圖片預覽
						base64Input.value = ""; // 清空 Base64 值
						removeBtn.style.display = "none"; // 隱藏刪除按鈕
					} else {
						errorMsg.style.display = "none"; // 隱藏錯誤訊息

						// 預覽圖片與存儲 Base64
						const reader = new FileReader();
						reader.onload = function (e) {
							previewImg.src = e.target.result;
							previewImg.style.display = "block";
							base64Input.value = e.target.result;
							removeBtn.style.display = "inline-block";
						};
						reader.readAsDataURL(file);
					}
				});

				// 綁定刪除按鈕事件
				if (removeBtn) {
					removeBtn.addEventListener("click", function () {
						previewImg.style.display = "none";
						previewImg.src = "";
						base64Input.value = "";
						fileInput.value = "";
						removeBtn.style.display = "none";
						errorMsg.style.display = "none";
					});
				}
			});
		});
	</script>
	<script th:inline="javascript">
		$(document).ready(function () {
			// 檢查頁面加載時是否有 Base64 資料
			var base64Data = $("#stampFileBase64").val();

			// 在頁面加載時打印 base64Data 值
			console.log("Loaded Base64 data: ", base64Data);


			// 如果 Base64 資料存在，顯示圖片
			if (base64Data) {
				$("#sealImagePreview").attr("src", base64Data).show();  // 設置圖片預覽的 src 並顯示圖片
				$("#removeImageBtn").show();  // 顯示刪除按鈕
			}
			// 當選擇圖片時，觸發預覽功能
			$("#sealImage").on("change", function () {
				var file = this.files[0];
				if (file) {
					var reader = new FileReader();
					reader.onload = function (e) {
						// 顯示圖片預覽
						$("#sealImagePreview").attr("src", e.target.result).show();
						// 將圖片轉為 Base64 存入隱藏欄位
						$("#stampFileBase64").val(e.target.result);
						// 顯示刪除按鈕
						$("#removeImageBtn").show();
					};
					reader.readAsDataURL(file);
				}
			});

			// 當點擊刪除圖片按鈕時，刪除圖片和相關資料
			$("#removeImageBtn").on("click", function () {
				// 清除圖片預覽
				$("#sealImagePreview").attr("src", "").hide();
				// 清空 file input 的值
				$("#sealImage").val("");
				// 清空 Base64 的隱藏欄位
				$("#stampFileBase64").val("");
				// 隱藏刪除按鈕
				$("#removeImageBtn").hide();
			});
		});
	</script>
	<script th:src="@{/js/adm/tree.js}"></script>
	<script th:inline="javascript">
	/*<![CDATA[*/
	var treeUtil;
	$(function() {
		// 建立aceTreeUtil工具類別
		treeUtil = new aceTreeUtil();
		treeUtil.sTreeId = '#aceTree';
		treeUtil.sQueryUrl = /*[[@{/jdDeptMgnt/getDepts}]]*/;
		
		// 根節點初始化的function
		treeUtil.fnInitRoot = function(response) {
			alertMsg(response.resultMsg);
			$('#rootDiv').show();
		};
		// 節點選擇function
		treeUtil.fnNodeSelected = function(nodeData) {
			// 設定同步
			console.log("Selected node data:", nodeData); // 確認整個節點資料
			getParentDepList(nodeData);
			$('#addForm #parentDepDiv').html(nodeData.target.text);
			$('#nodeForm #parentDep').val(nodeData.target.parentDep);
			$('#nodeForm #depId').val(nodeData.target.id);
			$('#nodeForm #depName').val(nodeData.target.text);
			$('#nodeForm #branchId').val(nodeData.target.branchId);
			$('#nodeForm #description').val(nodeData.target.description);
			$('#nodeForm #notify').val(nodeData.target.notify);
			// $('#nodeDiv').show();
			// 讀取圖片的 Base64 資料並顯示
			var base64Image = nodeData.target.stampFileBase64;  // 假設 stampFileBase64 是圖片的 Base64 資料
			if (base64Image) {
				$("#sealImagePreview").attr("src", base64Image).show();  // 顯示圖片
				$("#stampFileBase64").val(base64Image);  // 將 Base64 資料存入隱藏欄位
				$("#removeImageBtn").show();  // 顯示刪除按鈕
			} else {
				$("#sealImagePreview").hide();
				$("#removeImageBtn").hide();
			}

			$('#nodeDiv').show();
		};
		// 節點反選function
		treeUtil.fnNodeDeselected = function() {
			$('#nodeDiv').hide();
		};
		treeUtil.show();
		
		// 部門管理-新增Root節點事件(一開始只有系統沒有根目錄時須新增根目錄)
		$('#addRootBtn').click(function() {
			if ($('#rootDiv #depName').val() == '') {
				alertMsg("請輸入部門名稱");
				return false;
			}
			
			var formData = {
				depId : '0',
				depName : $('#rootDiv #depName').val(),
				description : $('#rootDiv #description').val()
			};
			eserviceForm.post(/*[[@{/jdDeptMgnt/insertDepartment}]]*/, formData, function(response) {
				alertMsg(response.resultMsg);
				initFunction();
				treeUtil.show();
			});
		});
		
		// 項目屬性設定-新增節點事件
		$('#addNodeBtn').on('click', function() {
			var dialog = $('#dialog-message').removeClass('hide').dialog({
				modal: true,
				title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='my-icon fa fa-check'></i>新增部門</h4></div>",
				title_html: true,
				close: function() {
					$('#addForm')[0].reset();
				},
				buttons: [ 
					{
						text: '取消',
						'class' : 'btn',
						click: function() {
							$(this).dialog('close');
							$('#addForm')[0].reset();
						} 
					},
					{
						text: '確定',
						'class' : 'btn btn-primary',
						click: function() {
							if ($('#addForm #depName').val() == '') {
								alertMsg("請輸入部門名稱");
								return false;
							}
							var formData = {
								parentDep : $('#nodeDiv #depId').val(),
								depId : $('#addForm #depId').val(),
								depName : $('#addForm #depName').val(),
								branchId: $('#addForm #branchId').val(),
								description : $('#addForm #description').val(),
								stampFileBase64: $('#stampFileBase64').val()  // 圖片的 Base64 資料
							};
							eserviceForm.post(/*[[@{/jdDeptMgnt/insertDepartment}]]*/, formData, function(response) {
								alertMsg(response.resultMsg);
								initFunction();
								treeUtil.show();
								$('#nodeDiv').show();
							});
							
							$(this).dialog('close');
							$('#addForm')[0].reset();
						} 
					}
				],
				width: 600
			});	
		});
		
		// 項目屬性設定-刪除節點事件
		$('#delNodeBtn').on('click', function() {
			var notify = $('#nodeForm #notify').val();
			if (notify == 'Y' || notify ==  'R') {
				alertMsg('此目錄下還有其它子項目，故不可刪除');
				return false;
			}
			confirmMsg('是否確認刪除', function(r) {
				if (r) {
					var formData = {
						depId : $('#nodeForm #depId').val()
					};
					eserviceForm.post(/*[[@{/jdDeptMgnt/deleteDepartment}]]*/, formData, function(response) {
						alertMsg(response.resultMsg);
						initFunction();
						treeUtil.show();
						$('#nodeDiv').show();
					});
				} else {
					return false;
				}
			});
		});
		
		// 項目屬性設定-更新節點事件
		$('#updNodeBtn').on('click', function(e) {
			if ($('#nodeForm #depName').val() == '') {
				alertMsg('請輸入部門名稱');
				return false;
			}
			// 檢查是否選擇檔案並檢查大小
			const fileInput = document.querySelector("#sealImage");
			if (fileInput && fileInput.files.length > 0) {
				const file = fileInput.files[0];
				const maxSize = 2 * 1024 * 1024; // 2MB in bytes

				// 檔案大小超過 2MB 時阻止提交
				if (file.size > maxSize) {
					alert("圖片大小不可超過 2MB，請重新上傳！");
					return false;
				}
			}
			confirmMsg('是否確認修改', function(r) {
				if (r) {
					var formData = {
						depId :$('#nodeForm #depId').val(),
						parentDep : $('#nodeForm #parentDep').val(),
						depName : $('#nodeForm #depName').val(),
						branchId: $('#nodeForm #branchId').val(),
						description : $('#nodeForm #description').val(),
						stampFileBase64: $('#stampFileBase64').val()  // 圖片的 Base64 資料
					};
					eserviceForm.post(/*[[@{/jdDeptMgnt/updateDepartment}]]*/, formData, function(response) {
						alertMsg(response.resultMsg);
						initFunction();
						treeUtil.show();
						$('#nodeDiv').show();
						window.location.reload();
					});
				} else {
					return false;
				}
			});
		});
		
		eserviceAdmEvent.initDialog();
	});

	// 部門樹、項目屬性設定、部門管理初始化
	function initFunction() {
		// 部門樹初始化
		$('#aceTreeDiv').empty();
		$('#aceTreeDiv').append('<div class="tree-container-min"><ul id="aceTree"></ul></div>');
		$('#aceTreeDiv').append('<div class="space-4"></div>');
		// 項目屬性設定初始化
		$('#nodeForm')[0].reset();
		$('#nodeDiv').hide();
		// 部門管理初始化
		$('#rootDiv').hide();
	}

	// 取得上一層部門清單
	function getParentDepList(nodeData) {
		var formData = {
			parentDep : nodeData.target.parentDep
		};
		eserviceForm.post(/*[[@{/jdDeptMgnt/getParentDepList}]]*/, formData, function(response) {
			if (response.result == 'SUCCESS') {
				$('#nodeForm #parentDepDiv').html(nodeData.target.par);
				// if (response.resultData.length <= 1) {
				//
				// } else {
				// 	$('#nodeForm #parentDepDiv').html('');
				// 	var optHtml = '';
				// 	optHtml += '<select id="parentDepOpt" class="form-control" onchange="$(\'#nodeForm #parentDep\').val(this.value);">';
				//
				// 	$.each(response.resultData, function(i, obj) {
				// 		var selected = '';
				// 		if (obj.depId == nodeData.target.parentDep) {
				// 			selected = 'selected="selected"';
				// 		}
				// 		optHtml += ('<option value="' + obj.depId + '" ' + selected + '>' + obj.depName + '</option>');
				// 	});
				// 	optHtml += '</select>';
				// 	$('#nodeForm #parentDepDiv').html(optHtml);
				// }
			}
		});
	}
	
	/*]]>*/
	</script>
</html>
